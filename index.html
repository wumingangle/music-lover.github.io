<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客製化歌曲推薦 App</title>

    <!-- PWA 設定 -->
    <meta name="theme-color" content="#8b5cf6"/>
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/8b5cf6/ffffff?text=🎵&font=noto">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuW+l+S4i+W8j+WKoOWvueiBlOiBlOAppIiwKICAic2hvcnRfbmFtZSI6ICLnur/lkIPlvI/liqIiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzExMTgyNyIsCiAgInRoZW1lX2NvbG9yIjogIiM4YjVjZjYiLAogICJkZXNjcmlwdGlvbiI6ICLmsYnlkI/lhbbkvZXnur/lkIPlvI/liqIsIOWcsOWdg+S4iOS9kOiBlOWKoOWvueiBlOAppIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vMTkyeDE5Mi84YjVjZjYvZmZmZmZmP3RleHQ98J+NmAhmb250PW5vdG8iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi84YjVjZjYvZmZmZmZmP3RleHQ98J+NmAhmb250PW5vdG8iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0K">

    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入 Lucide 圖示庫 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            cursor: pointer;
            transition: color 0.2s;
        }
        .star-rating input[type="radio"]:checked ~ label,
        .star-rating:not(:checked) > label:hover,
        .star-rating:not(:checked) > label:hover ~ label {
            color: #fBBF24; /* amber-400 */
        }
        .star-rating input[type="radio"] + label:hover,
        .star-rating input[type="radio"] + label:hover ~ label,
        .star-rating input[type="radio"]:checked + label {
            color: #F59E0B; /* amber-500 */
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #analysis-panel.hidden, #app-container.hidden, #login-container.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <!-- 登入畫面 -->
    <div id="login-container" class="w-full max-w-2xl mx-auto text-center py-20 fade-in">
        <h1 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">歡迎使用</h1>
        <p class="text-gray-400 mt-4 mb-8 text-lg">登入以開始您的個人化音樂之旅，<br>並將您的偏好安全地儲存於雲端。</p>
        <button id="google-login-btn" class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg flex items-center justify-center mx-auto hover:bg-gray-200 transition-transform transform hover:scale-105 shadow-lg">
            <svg class="w-6 h-6 mr-3" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.519-3.486-11.181-8.23l-6.573,4.818C9.656,39.663,16.318,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,35.212,44,30.038,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            使用 Google 帳號登入
        </button>
        <div class="my-4 text-gray-500">或</div>
        <button id="guest-login-btn" class="text-purple-400 hover:text-purple-300 transition-colors font-semibold">
            以訪客身分繼續
        </button>
    </div>

    <!-- 主應用程式畫面 -->
    <div id="app-container" class="w-full max-w-2xl mx-auto pb-10 hidden">
        <header class="text-center mb-8 relative">
            <!-- 左側按鈕區 -->
            <div class="absolute left-0 top-1/2 -translate-y-1/2 flex items-center space-x-2">
                 <button id="analysis-btn" class="bg-gray-800 p-2 rounded-full hover:bg-gray-700 transition duration-200" title="查看品味分析">
                    <i data-lucide="pie-chart" class="text-purple-400"></i>
                </button>
            </div>
           
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">您的每日推薦</h1>
            <p class="text-gray-400 mt-2">每天發現五首新歌，打造您的專屬品味。</p>
            
            <!-- 右側使用者資訊與登出按鈕 -->
            <div class="absolute right-0 top-1/2 -translate-y-1/2 flex items-center space-x-3">
                 <span id="user-display" class="text-sm text-gray-300 hidden md:block"></span>
                 <button id="logout-btn" class="bg-gray-800 p-2 rounded-full hover:bg-gray-700 transition duration-200" title="登出">
                    <i data-lucide="log-out" class="text-red-400"></i>
                </button>
            </div>
        </header>

        <!-- 讀取畫面 -->
        <div id="loader" class="text-center py-10">
            <div role="status" class="flex justify-center items-center">
                <svg aria-hidden="true" class="w-8 h-8 text-gray-600 animate-spin fill-purple-500" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                    <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                </svg>
                <span class="ml-3">正在為您載入今日推薦...</span>
            </div>
        </div>

        <!-- 歌曲列表 -->
        <div id="song-list" class="space-y-4"></div>

        <!-- 儲存按鈕 -->
        <div id="save-button-container" class="text-center mt-6 hidden">
            <button id="save-ratings-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg">
                儲存我的評分
            </button>
        </div>
        
        <!-- 訊息提示框 -->
        <div id="toast" class="fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300"></div>

        <footer class="text-center mt-10 text-gray-500 text-sm">
            <p>您的專屬使用者 ID (可用於分享與協作):</p>
            <p id="user-id" class="mt-1 font-mono bg-gray-800 px-2 py-1 rounded inline-block">正在初始化...</p>
        </footer>
    </div>
    
    <!-- 分析面板 (Modal) -->
    <div id="analysis-panel" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-lg p-6 relative animate-fadeIn">
            <button id="close-panel-btn" class="absolute top-4 right-4 text-gray-500 hover:text-white">
                <i data-lucide="x"></i>
            </button>
            <h2 class="text-2xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">您的音樂品味分析</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><h3 class="font-semibold mb-2 text-lg">偏好曲風</h3><div id="genre-analysis" class="space-y-2"></div></div>
                <div><h3 class="font-semibold mb-2 text-lg">偏好節奏</h3><div id="tempo-analysis" class="space-y-2"></div></div>
                <div><h3 class="font-semibold mb-2 text-lg">偏好編曲</h3><div id="arrangement-analysis" class="space-y-2"></div></div>
                <div><h3 class="font-semibold mb-2 text-lg">偏好歌詞</h3><div id="lyrics-analysis" class="space-y-2"></div></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, signOut, signInAnonymously, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // --- 全域變數與設定 ---
        const ARTIFACT_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-song-recommender';
        const firebaseConfig = {
          apiKey: "AIzaSyB2NWv5sIgESimdCgBJ4pr50CAPAfF3I88",
          authDomain: "music-lover-89430.firebaseapp.com",
          projectId: "music-lover-89430",
          storageBucket: "music-lover-89430.appspot.com",
          messagingSenderId: "428251252845",
          appId: "1:428251252845:web:95826eeaf12075b9edd764",
          measurementId: "G-VJ5S6JXDF6"
        };
        let app, auth, db, analytics, userId, currentUserData;
        let pendingRatings = {};
        let hasSavedToday = false;

        // --- 歌曲資料庫 ---
        const ALL_SONGS = [
            // Pop
            { id: 's001', title: 'Blinding Lights', artist: 'The Weeknd', genre: 'Synth-pop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Emotional' },
            { id: 's002', title: 'Shape of You', artist: 'Ed Sheeran', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Acoustic', lyrics: 'Upbeat' },
            { id: 's003', title: 'Someone You Loved', artist: 'Lewis Capaldi', genre: 'Ballad', tempo: 'Slow', arrangement: 'Minimalist', lyrics: 'Storytelling' },
            { id: 's004', title: 'Dance Monkey', artist: 'Tones and I', genre: 'Electropop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's006', title: 'Closer', artist: 'The Chainsmokers ft. Halsey', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Emotional' },
            { id: 's008', title: 'bad guy', artist: 'Billie Eilish', genre: 'Electropop', tempo: 'Mid', arrangement: 'Minimalist', lyrics: 'Abstract' },
            { id: 's009', title: 'Perfect', artist: 'Ed Sheeran', genre: 'Ballad', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's011', title: 'Thinking Out Loud', artist: 'Ed Sheeran', genre: 'Ballad', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Emotional' },
            { id: 's016', title: 'Billie Jean', artist: 'Michael Jackson', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Storytelling' },
            { id: 's020', title: 'Rolling in the Deep', artist: 'Adele', genre: 'Soul', tempo: 'Upbeat', arrangement: 'Orchestral', lyrics: 'Emotional' },
            { id: 's026', title: 'Watermelon Sugar', artist: 'Harry Styles', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Acoustic', lyrics: 'Upbeat' },
            { id: 's027', title: 'Good 4 U', artist: 'Olivia Rodrigo', genre: 'Pop Punk', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's028', title: 'Levitating', artist: 'Dua Lipa', genre: 'Nu-disco', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's029', title: 'As It Was', artist: 'Harry Styles', genre: 'Synth-pop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Emotional' },
            { id: 's030', title: 'Stay', artist: 'The Kid LAROI & Justin Bieber', genre: 'Pop', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Emotional' },
            { id: 's031', title: 'Happy', artist: 'Pharrell Williams', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's032', title: 'Shake It Off', artist: 'Taylor Swift', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's033', title: 'Call Me Maybe', artist: 'Carly Rae Jepsen', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's034', title: '...Baby One More Time', artist: 'Britney Spears', genre: 'Pop', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Emotional' },
            { id: 's035', title: 'I Wanna Dance with Somebody', artist: 'Whitney Houston', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            
            // Rock
            { id: 's012', title: 'Hotel California', artist: 'Eagles', genre: 'Rock', tempo: 'Mid', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's013', title: 'Bohemian Rhapsody', artist: 'Queen', genre: 'Rock', tempo: 'Varied', arrangement: 'Orchestral', lyrics: 'Abstract' },
            { id: 's014', title: 'Smells Like Teen Spirit', artist: 'Nirvana', genre: 'Grunge', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Abstract' },
            { id: 's015', title: 'Wonderwall', artist: 'Oasis', genre: 'Britpop', tempo: 'Mid', arrangement: 'Acoustic', lyrics: 'Emotional' },
            { id: 's017', title: 'Like a Rolling Stone', artist: 'Bob Dylan', genre: 'Folk Rock', tempo: 'Mid', arrangement: 'Band', lyrics: 'Storytelling' },
            { id: 's018', title: 'Stairway to Heaven', artist: 'Led Zeppelin', genre: 'Rock', tempo: 'Varied', arrangement: 'Acoustic', lyrics: 'Abstract' },
            { id: 's022', title: 'Creep', artist: 'Radiohead', genre: 'Alternative Rock', tempo: 'Slow', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's023', title: 'Yellow', artist: 'Coldplay', genre: 'Alternative Rock', tempo: 'Mid', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's025', title: 'Sweet Child o\' Mine', artist: 'Guns N\' Roses', genre: 'Hard Rock', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's036', title: 'Livin\' on a Prayer', artist: 'Bon Jovi', genre: 'Rock', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Storytelling' },
            { id: 's037', title: 'Don\'t Stop Believin\'', artist: 'Journey', genre: 'Rock', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's038', title: 'Back in Black', artist: 'AC/DC', genre: 'Hard Rock', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's039', title: 'Seven Nation Army', artist: 'The White Stripes', genre: 'Alternative Rock', tempo: 'Mid', arrangement: 'Minimalist', lyrics: 'Upbeat' },
            { id: 's040', title: 'Mr. Brightside', artist: 'The Killers', genre: 'Alternative Rock', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Storytelling' },
            { id: 's041', title: 'Come As You Are', artist: 'Nirvana', genre: 'Grunge', tempo: 'Mid', arrangement: 'Band', lyrics: 'Abstract' },
            { id: 's042', title: 'Under the Bridge', artist: 'Red Hot Chili Peppers', genre: 'Alternative Rock', tempo: 'Mid', arrangement: 'Band', lyrics: 'Storytelling' },
            { id: 's043', title: 'Every Breath You Take', artist: 'The Police', genre: 'Rock', tempo: 'Mid', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's044', title: 'Zombie', artist: 'The Cranberries', genre: 'Alternative Rock', tempo: 'Mid', arrangement: 'Band', lyrics: 'Protest' },
            { id: 's045', title: 'In the End', artist: 'Linkin Park', genre: 'Nu Metal', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Emotional' },
            { id: 's046', title: 'Losing My Religion', artist: 'R.E.M.', genre: 'Alternative Rock', tempo: 'Mid', arrangement: 'Acoustic', lyrics: 'Abstract' },

            // Hip-hop / R&B
            { id: 's005', title: 'Rockstar', artist: 'Post Malone ft. 21 Savage', genre: 'Hip-hop', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Lifestyle' },
            { id: 's007', title: 'One Dance', artist: 'Drake ft. Wizkid & Kyla', genre: 'Dancehall', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's021', title: 'Lose Yourself', artist: 'Eminem', genre: 'Hip-hop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Storytelling' },
            { id: 's010', title: 'Uptown Funk', artist: 'Mark Ronson ft. Bruno Mars', genre: 'Funk', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's047', title: 'Sicko Mode', artist: 'Travis Scott', genre: 'Hip-hop', tempo: 'Varied', arrangement: 'Electronic', lyrics: 'Lifestyle' },
            { id: 's048', title: 'God\'s Plan', artist: 'Drake', genre: 'Hip-hop', tempo: 'Slow', arrangement: 'Electronic', lyrics: 'Lifestyle' },
            { id: 's049', title: 'Old Town Road', artist: 'Lil Nas X ft. Billy Ray Cyrus', genre: 'Country Rap', tempo: 'Upbeat', arrangement: 'Acoustic', lyrics: 'Upbeat' },
            { id: 's050', title: 'See You Again', artist: 'Wiz Khalifa ft. Charlie Puth', genre: 'Hip-hop', tempo: 'Slow', arrangement: 'Minimalist', lyrics: 'Emotional' },
            { id: 's051', title: 'Juicy', artist: 'The Notorious B.I.G.', genre: 'Hip-hop', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Storytelling' },
            { id: 's052', title: 'Empire State of Mind', artist: 'JAY-Z ft. Alicia Keys', genre: 'Hip-hop', tempo: 'Mid', arrangement: 'Orchestral', lyrics: 'Lifestyle' },
            { id: 's053', title: 'Crazy in Love', artist: 'Beyoncé ft. JAY-Z', genre: 'R&B', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's054', title: 'No Scrubs', artist: 'TLC', genre: 'R&B', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Lifestyle' },
            { id: 's055', title: 'Doo Wop (That Thing)', artist: 'Lauryn Hill', genre: 'Hip-hop', tempo: 'Mid', arrangement: 'Band', lyrics: 'Protest' },
            { id: 's056', title: 'Get Ur Freak On', artist: 'Missy Elliott', genre: 'Hip-hop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's057', title: 'Hotline Bling', artist: 'Drake', genre: 'R&B', tempo: 'Slow', arrangement: 'Minimalist', lyrics: 'Emotional' },
            { id: 's058', title: 'HUMBLE.', artist: 'Kendrick Lamar', genre: 'Hip-hop', tempo: 'Upbeat', arrangement: 'Minimalist', lyrics: 'Protest' },
            { id: 's059', title: 'Superstition', artist: 'Stevie Wonder', genre: 'Funk', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Abstract' },
            { id: 's060', title: 'I Will Always Love You', artist: 'Whitney Houston', genre: 'Soul', tempo: 'Slow', arrangement: 'Orchestral', lyrics: 'Emotional' },

            // Folk / Country / Ballad
            { id: 's019', title: 'Hallelujah', artist: 'Leonard Cohen', genre: 'Folk', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Abstract' },
            { id: 's024', title: 'Take Me Home, Country Roads', artist: 'John Denver', genre: 'Country', tempo: 'Mid', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's061', title: 'Jolene', artist: 'Dolly Parton', genre: 'Country', tempo: 'Mid', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's062', title: 'The Sound of Silence', artist: 'Simon & Garfunkel', genre: 'Folk', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Emotional' },
            { id: 's063', title: 'American Pie', artist: 'Don McLean', genre: 'Folk Rock', tempo: 'Varied', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's064', title: 'Fast Car', artist: 'Tracy Chapman', genre: 'Folk', tempo: 'Mid', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's065', title: 'Yesterday', artist: 'The Beatles', genre: 'Ballad', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Emotional' },
            { id: 's066', title: 'Bridge Over Troubled Water', artist: 'Simon & Garfunkel', genre: 'Ballad', tempo: 'Slow', arrangement: 'Orchestral', lyrics: 'Emotional' },
            { id: 's067', title: 'Let It Be', artist: 'The Beatles', genre: 'Ballad', tempo: 'Slow', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's068', title: 'I Can\'t Help Falling in Love', artist: 'Elvis Presley', genre: 'Ballad', tempo: 'Slow', arrangement: 'Minimalist', lyrics: 'Emotional' },
            { id: 's069', title: 'My Heart Will Go On', artist: 'Céline Dion', genre: 'Ballad', tempo: 'Slow', arrangement: 'Orchestral', lyrics: 'Emotional' },
            { id: 's070', title: 'Angie', artist: 'The Rolling Stones', genre: 'Ballad', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Emotional' },
            
            // Electronic / Dance
            { id: 's071', title: 'Get Lucky', artist: 'Daft Punk ft. Pharrell Williams', genre: 'Nu-disco', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's072', title: 'One More Time', artist: 'Daft Punk', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's073', title: 'Levels', artist: 'Avicii', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Instrumental' },
            { id: 's074', title: 'Titanium', artist: 'David Guetta ft. Sia', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Emotional' },
            { id: 's075', title: 'Blue Monday', artist: 'New Order', genre: 'Synth-pop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Abstract' },
            { id: 's076', title: 'Around the World', artist: 'Daft Punk', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Repetitive' },
            { id: 's077', title: 'Don\'t You Worry Child', artist: 'Swedish House Mafia', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Storytelling' },
            { id: 's078', title: 'Lean On', artist: 'Major Lazer & DJ Snake', genre: 'EDM', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's079', title: 'Wake Me Up', artist: 'Avicii', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's080', title: 'This Is What You Came For', artist: 'Calvin Harris ft. Rihanna', genre: 'EDM', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Upbeat' },

            // Others
            { id: 's081', title: 'Imagine', artist: 'John Lennon', genre: 'Soft Rock', tempo: 'Slow', arrangement: 'Minimalist', lyrics: 'Protest' },
            { id: 's082', title: 'What a Wonderful World', artist: 'Louis Armstrong', genre: 'Jazz', tempo: 'Slow', arrangement: 'Orchestral', lyrics: 'Upbeat' },
            { id: 's083', title: 'Stand By Me', artist: 'Ben E. King', genre: 'Soul', tempo: 'Mid', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's084', title: 'I Want to Hold Your Hand', artist: 'The Beatles', genre: 'Pop Rock', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Upbeat' },
            { id: 's085', title: 'Hey Jude', artist: 'The Beatles', genre: 'Rock', tempo: 'Varied', arrangement: 'Orchestral', lyrics: 'Upbeat' },
            { id: 's086', title: 'Respect', artist: 'Aretha Franklin', genre: 'Soul', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Protest' },
            { id: 's087', title: 'Good Vibrations', artist: 'The Beach Boys', genre: 'Psychedelic Pop', tempo: 'Varied', arrangement: 'Orchestral', lyrics: 'Abstract' },
            { id: 's088', title: 'My Girl', artist: 'The Temptations', genre: 'Soul', tempo: 'Mid', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's089', title: 'Ain\'t No Mountain High Enough', artist: 'Marvin Gaye & Tammi Terrell', genre: 'Soul', tempo: 'Upbeat', arrangement: 'Orchestral', lyrics: 'Upbeat' },
            { id: 's090', title: 'What\'s Going On', artist: 'Marvin Gaye', genre: 'Soul', tempo: 'Mid', arrangement: 'Band', lyrics: 'Protest' },
            { id: 's091', title: 'Born to Run', artist: 'Bruce Springsteen', genre: 'Rock', tempo: 'Upbeat', arrangement: 'Band', lyrics: 'Storytelling' },
            { id: 's092', title: 'No Woman, No Cry', artist: 'Bob Marley & The Wailers', genre: 'Reggae', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Storytelling' },
            { id: 's093', title: 'Redemption Song', artist: 'Bob Marley & The Wailers', genre: 'Reggae', tempo: 'Slow', arrangement: 'Acoustic', lyrics: 'Protest' },
            { id: 's094', title: 'Piano Man', artist: 'Billy Joel', genre: 'Soft Rock', tempo: 'Mid', arrangement: 'Minimalist', lyrics: 'Storytelling' },
            { id: 's095', title: 'Africa', artist: 'Toto', genre: 'Soft Rock', tempo: 'Mid', arrangement: 'Band', lyrics: 'Abstract' },
            { id: 's096', title: 'Take on Me', artist: 'a-ha', genre: 'Synth-pop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Storytelling' },
            { id: 's097', title: 'Girls Just Want to Have Fun', artist: 'Cyndi Lauper', genre: 'Pop', tempo: 'Upbeat', arrangement: 'Electronic', lyrics: 'Upbeat' },
            { id: 's098', title: 'Sweet Dreams (Are Made of This)', artist: 'Eurythmics', genre: 'Synth-pop', tempo: 'Mid', arrangement: 'Electronic', lyrics: 'Abstract' },
            { id: 's099', title: 'With or Without You', artist: 'U2', genre: 'Rock', tempo: 'Mid', arrangement: 'Band', lyrics: 'Emotional' },
            { id: 's100', title: 'Purple Rain', artist: 'Prince', genre: 'Rock', tempo: 'Slow', arrangement: 'Band', lyrics: 'Emotional' }
        ];

        // --- 主應用程式邏輯 ---
        window.onload = () => {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                analytics = getAnalytics(app);
                
                registerServiceWorker();
                handleAuthentication();
                
                document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);
                document.getElementById('guest-login-btn').addEventListener('click', signInAsGuest);
                document.getElementById('logout-btn').addEventListener('click', signOutUser);
                document.getElementById('analysis-btn').addEventListener('click', openAnalysisPanel);
                document.getElementById('close-panel-btn').addEventListener('click', closeAnalysisPanel);
                document.getElementById('analysis-panel').addEventListener('click', (e) => {
                    if (e.target.id === 'analysis-panel') closeAnalysisPanel();
                });
                document.getElementById('save-ratings-btn').addEventListener('click', savePendingRatings);

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                document.getElementById('loader').innerText = '應用程式初始化失敗，請檢查主控台。';
            }
        };

        // --- PWA Service Worker 註冊 ---
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'song-recommender-cache-v1';
                    const urlsToCache = [
                        '/',
                        'https://cdn.tailwindcss.com',
                        'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap',
                        'https://unpkg.com/lucide@latest'
                    ];

                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then(cache => {
                                console.log('Opened cache');
                                // 使用 no-cors 模式來快取跨來源資源，但不保證回應內容正確性
                                const requests = urlsToCache.map(url => new Request(url, { mode: 'no-cors' }));
                                return cache.addAll(requests);
                            }).catch(err => console.error('Cache addAll failed:', err))
                        );
                    });

                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => {
                                return response || fetch(event.request);
                            })
                        );
                    });
                `;
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('ServiceWorker Registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker Registration failed: ', error);
                    });
            }
        }


        // --- 驗證邏輯 ---
        function handleAuthentication() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // 使用者已登入
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId;
                    document.getElementById('user-display').textContent = user.isAnonymous ? '訪客' : (user.displayName || user.email);

                    document.getElementById('login-container').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    
                    await main();
                } else {
                    // 使用者已登出或尚未登入
                    // 在這裡，我們也檢查一下是否是剛從登入頁面跳轉回來
                    getRedirectResult(auth).then(async (result) => {
                        if (result) {
                            // 如果 result 存在，表示是剛登入成功。
                            // onAuthStateChanged 會自動再次觸發，屆時上面的 if (user) 區塊就會執行。
                            // 這裡我們先顯示一個讀取中的畫面，避免登入畫面閃爍。
                            document.getElementById('loader').style.display = 'flex';
                            document.getElementById('login-container').classList.add('hidden');
                            document.getElementById('app-container').classList.remove('hidden'); // 顯示 app 容器以容納 loader
                        } else {
                            // 如果 result 是 null，表示使用者是真的未登入，此時才顯示登入畫面。
                            document.getElementById('login-container').classList.remove('hidden');
                            document.getElementById('app-container').classList.add('hidden');
                        }
                    }).catch(error => {
                        console.error("處理登入重導向時發生錯誤:", error);
                        // 發生錯誤時，還是顯示登入畫面
                        document.getElementById('login-container').classList.remove('hidden');
                        document.getElementById('app-container').classList.add('hidden');
                    });
                }
            });
        }

        async function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            try {
                // 改用頁面重定向登入，以解決彈出視窗在某些環境下的網域授權問題
                await signInWithRedirect(auth, provider);
                // onAuthStateChanged 會在頁面重定向回來後自動處理使用者狀態
            } catch (error) {
                console.error("Google 登入失敗:", error);
                showToast("Google 登入失敗，請稍後再試。這可能是由於預覽環境的限制。", false);
            }
        }

        async function signInAsGuest() {
            try {
                await signInAnonymously(auth);
                // onAuthStateChanged 會處理後續的 UI 更新
            } catch (error) {
                console.error("匿名登入失敗:", error);
                showToast("訪客登入失敗，請稍後再試。", false);
            }
        }

        async function signOutUser() {
            try {
                await signOut(auth);
                // onAuthStateChanged 會處理 UI 變更
                showToast("您已成功登出。", true);
            } catch (error) {
                console.error("登出失敗:", error);
            }
        }
        
        async function main() {
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('song-list').style.display = 'none';

            currentUserData = await getUserData();
            const today = new Date().toISOString().split('T')[0];

            // 重設旗標
            hasSavedToday = false;

            if (currentUserData.lastRecommendationDate === today && currentUserData.dailyRecommendations?.length > 0) {
                // 檢查今天的歌曲是否已經有評分
                if (currentUserData.dailyRecommendations.some(songId => currentUserData.ratings[songId])) {
                    hasSavedToday = true;
                }
                displaySongs(currentUserData.dailyRecommendations, currentUserData.ratings);
            } else {
                const newRecommendations = await generateNewRecommendations(currentUserData);
                await saveDailyRecommendations(newRecommendations);
                currentUserData.dailyRecommendations = newRecommendations;
                currentUserData.lastRecommendationDate = today;
                displaySongs(newRecommendations, currentUserData.ratings);
            }

            document.getElementById('loader').style.display = 'none';
            document.getElementById('song-list').style.display = 'block';
        }

        async function getUserData() {
            const userDocRef = doc(db, `artifacts/${ARTIFACT_ID}/users/${userId}`);
            const userDocSnap = await getDoc(userDocRef);

            if (userDocSnap.exists()) {
                const data = userDocSnap.data();
                data.tasteProfile = data.tasteProfile || {};
                data.tasteProfile.genres = data.tasteProfile.genres || {};
                data.tasteProfile.tempos = data.tasteProfile.tempos || {};
                data.tasteProfile.arrangements = data.tasteProfile.arrangements || {};
                data.tasteProfile.lyrics = data.tasteProfile.lyrics || {};
                return data;
            } else {
                const newUser = {
                    ratings: {},
                    tasteProfile: { genres: {}, tempos: {}, arrangements: {}, lyrics: {} }, 
                    lastRecommendationDate: null,
                    dailyRecommendations: []
                };
                await setDoc(userDocRef, newUser);
                return newUser;
            }
        }
        
        function getSongById(songId) {
            return ALL_SONGS.find(song => song.id === songId);
        }

        function displaySongs(songIds, ratings) {
            const songList = document.getElementById('song-list');
            songList.innerHTML = '';
            songIds.forEach((songId, index) => {
                const song = getSongById(songId);
                if (!song) return;

                const card = document.createElement('div');
                card.className = 'bg-gray-800 p-5 rounded-lg flex items-start justify-between shadow-lg fade-in';
                card.style.animationDelay = `${index * 100}ms`;
                const ratingValue = ratings[song.id] || 0;
                
                const searchQuery = encodeURIComponent(`${song.title} ${song.artist}`);
                const youtubeUrl = `https://www.youtube.com/results?search_query=${searchQuery}`;

                card.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-white">${song.title}</h3>
                        <p class="text-gray-400">${song.artist}</p>
                        <div class="flex flex-wrap gap-2 mt-3">
                            <span class="bg-purple-900 text-purple-300 text-xs font-medium px-2.5 py-0.5 rounded-full">${song.genre}</span>
                            <span class="bg-teal-900 text-teal-300 text-xs font-medium px-2.5 py-0.5 rounded-full">${song.tempo}</span>
                            <span class="bg-sky-900 text-sky-300 text-xs font-medium px-2.5 py-0.5 rounded-full">${song.arrangement}</span>
                            <span class="bg-rose-900 text-rose-300 text-xs font-medium px-2.5 py-0.5 rounded-full">${song.lyrics}</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-end space-y-2 flex-shrink-0 ml-4">
                        <a href="${youtubeUrl}" target="_blank" title="在 YouTube 上收聽" class="text-gray-500 hover:text-red-500 transition-colors">
                            <i data-lucide="youtube"></i>
                        </a>
                        <div class="star-rating flex flex-row-reverse" data-song-id="${song.id}">
                            ${[5, 4, 3, 2, 1].map(star => `
                                <input type="radio" id="star${star}-${song.id}" name="rating-${song.id}" value="${star}" ${ratingValue == star ? 'checked' : ''} />
                                <label for="star${star}-${song.id}" class="text-gray-500 text-3xl" title="${star} 星">
                                   <i data-lucide="star" class="${ratingValue >= star ? 'fill-amber-400 text-amber-400' : ''}"></i>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
                songList.appendChild(card);
            });
            
            lucide.createIcons();
            document.querySelectorAll('.star-rating input').forEach(input => {
                input.addEventListener('change', stageRating);
            });
        }
        
        function stageRating(event) {
            const rating = parseInt(event.target.value);
            const songId = event.target.closest('.star-rating').dataset.songId;
            pendingRatings[songId] = rating;

            const starContainer = event.target.closest('.star-rating');
            const labels = starContainer.querySelectorAll('label');
            labels.forEach((label, index) => {
                const starValue = 5 - index;
                const starIcon = label.querySelector('svg');
                if (starIcon) {
                    if (starValue <= rating) {
                        starIcon.classList.add('fill-amber-400', 'text-amber-400');
                    } else {
                        starIcon.classList.remove('fill-amber-400', 'text-amber-400');
                    }
                }
            });
            
            document.getElementById('save-button-container').classList.remove('hidden');
            const saveBtn = document.getElementById('save-ratings-btn');
            if (hasSavedToday) {
                saveBtn.textContent = '更新我的評分';
            } else {
                saveBtn.textContent = '儲存我的評分';
            }
        }

        async function savePendingRatings() {
            if (Object.keys(pendingRatings).length === 0) {
                showToast("沒有需要儲存的新評分。", false);
                return;
            }

            showToast("正在儲存所有評分...");
            const userDocRef = doc(db, `artifacts/${ARTIFACT_ID}/users/${userId}`);

            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userDocRef);
                    if (!userDoc.exists()) throw "找不到使用者文件！";

                    const data = userDoc.data();
                    let newRatings = { ...data.ratings };
                    let newTasteProfile = JSON.parse(JSON.stringify(data.tasteProfile));

                    for (const songId in pendingRatings) {
                        const newRating = pendingRatings[songId];
                        const song = getSongById(songId);
                        if (!song) continue;

                        const oldRating = data.ratings[songId];
                        newRatings[songId] = newRating;
                        newTasteProfile = updateTasteProfile(newTasteProfile, song, newRating, oldRating);
                    }
                    
                    transaction.update(userDocRef, { 
                        ratings: newRatings,
                        tasteProfile: newTasteProfile
                    });
                    
                    currentUserData.ratings = newRatings;
                    currentUserData.tasteProfile = newTasteProfile;
                });

                showToast("所有評分已成功儲存！", true);
                pendingRatings = {};
                document.getElementById('save-button-container').classList.add('hidden');
                hasSavedToday = true;
            } catch (e) {
                console.error("儲存評分失敗: ", e);
                showToast("儲存失敗，請稍後再試。", false);
            }
        }

        function updateTasteProfile(profile, song, newRating, oldRating) {
            const ratingWeight = { 1: -2, 2: -1, 3: 0, 4: 1, 5: 2 };
            
            profile.genres = profile.genres || {};
            profile.tempos = profile.tempos || {};
            profile.arrangements = profile.arrangements || {};
            profile.lyrics = profile.lyrics || {};

            const categories = ['genre', 'tempo', 'arrangement', 'lyrics'];
            categories.forEach(category => {
                const value = song[category];
                const profileCategory = category === 'lyrics' ? 'lyrics' : `${category}s`;
                if (!profile[profileCategory][value]) profile[profileCategory][value] = { score: 0, count: 0 };

                if (oldRating) {
                    profile[profileCategory][value].score -= ratingWeight[oldRating];
                    if (profile[profileCategory][value].count > 0) profile[profileCategory][value].count -= 1;
                }
                
                profile[profileCategory][value].score += ratingWeight[newRating];
                profile[profileCategory][value].count += 1;
            });

            return profile;
        }

        async function generateNewRecommendations(userData) {
            const { ratings, tasteProfile } = userData;
            const ratedSongIds = Object.keys(ratings);
            const unratedSongs = ALL_SONGS.filter(song => !ratedSongIds.includes(song.id));

            if (unratedSongs.length < 5) { return unratedSongs.map(s => s.id); }
            if (ratedSongIds.length < 5) {
                return unratedSongs.sort(() => 0.5 - Math.random()).slice(0, 5).map(s => s.id);
            }

            const scoredSongs = unratedSongs.map(song => {
                let score = 0;
                const { genres, tempos, arrangements, lyrics } = tasteProfile;

                const genreProfile = genres && genres[song.genre];
                const tempoProfile = tempos && tempos[song.tempo];
                const arrangementProfile = arrangements && arrangements[song.arrangement];
                const lyricsProfile = lyrics && lyrics[song.lyrics];

                if (genreProfile && genreProfile.count > 0) score += (genreProfile.score / genreProfile.count) * 1.2;
                if (tempoProfile && tempoProfile.count > 0) score += tempoProfile.score / tempoProfile.count;
                if (arrangementProfile && arrangementProfile.count > 0) score += arrangementProfile.score / arrangementProfile.count;
                if (lyricsProfile && lyricsProfile.count > 0) score += lyricsProfile.score / lyricsProfile.count;

                score += (Math.random() - 0.5) * 0.1; 
                return { song, score };
            });

            scoredSongs.sort((a, b) => b.score - a.score);
            return scoredSongs.slice(0, 5).map(item => item.song.id);
        }

        async function saveDailyRecommendations(songIds) {
            const userDocRef = doc(db, `artifacts/${ARTIFACT_ID}/users/${userId}`);
            const today = new Date().toISOString().split('T')[0];
            await updateDoc(userDocRef, {
                dailyRecommendations: songIds,
                lastRecommendationDate: today
            });
        }
        
        let toastTimeout;
        function showToast(message, isSuccess = true) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300 ${isSuccess ? 'bg-purple-600' : 'bg-red-600'}`;
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            clearTimeout(toastTimeout);

            toastTimeout = setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
        
        function openAnalysisPanel() {
            populateAnalysisPanel(currentUserData.tasteProfile);
            document.getElementById('analysis-panel').classList.remove('hidden');
        }

        function closeAnalysisPanel() {
            document.getElementById('analysis-panel').classList.add('hidden');
        }

        function populateAnalysisPanel(tasteProfile) {
            renderCategory('genres', tasteProfile.genres, 'genre-analysis', 'purple');
            renderCategory('tempos', tasteProfile.tempos, 'tempo-analysis', 'teal');
            renderCategory('arrangements', tasteProfile.arrangements, 'arrangement-analysis', 'sky');
            renderCategory('lyrics', tasteProfile.lyrics, 'lyrics-analysis', 'rose');
        }

        function renderCategory(name, data, containerId, color) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            if (!data || Object.keys(data).length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">請先評分一些歌曲...</p>`;
                return;
            }

            const sortedItems = Object.entries(data)
                .map(([name, values]) => ({ name, ...values }))
                .filter(item => item.score > 0)
                .sort((a, b) => b.score - a.score)
                .slice(0, 5);
            
            if (sortedItems.length === 0) {
                container.innerHTML = `<p class="text-gray-500 text-sm">尚無明顯偏好...</p>`;
                return;
            }

            const maxScore = Math.max(...sortedItems.map(item => item.score), 1);

            sortedItems.forEach(item => {
                const percentage = (item.score / maxScore) * 100;
                const itemEl = document.createElement('div');
                itemEl.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-medium text-gray-300">${item.name}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2.5">
                        <div class="bg-${color}-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                `;
                container.appendChild(itemEl);
            });
        }
    </script>
</body>
</html>





